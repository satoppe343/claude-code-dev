services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TZ: ${TZ:-Asia/Tokyo}
    hostname: claude-code-dev
    # ファイアウォール (iptables) に必要
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../:/workspace:delegated # ワークスペース: macOS では delegated で性能改善
      - claude-code-history:/commandhistory # シェル履歴の永続化
      - claude-code-config:/home/node/.claude # Claude Code 認証情報・設定・メモリの永続化
      - ~/.gitconfig:/home/node/.gitconfig:ro # ホスト側の Git 設定を読み取り専用でマウント
      - ~/.ssh:/home/node/.ssh:ro # SSH 鍵を読み取り専用でマウント (git push 用)
    working_dir: /workspace
    environment:
      NODE_OPTIONS: "--max-old-space-size=4096" # 大規模コードベースでの OOM 防止
      CLAUDE_CONFIG_DIR: /home/node/.claude
      DEVCONTAINER: "true"
    # load-secrets.sh が macOS キーチェーンから生成する OAuth トークンファイル
    env_file:
      - path: .env.run
        required: false
    # コンテナが即終了しないように (devcontainer 以外での利用時)
    tty: true
    stdin_open: true
volumes:
  claude-code-history:
  claude-code-config:
